<template>
  <section>
    <header>
      <Navbar />
      <DropdownBanner
        :districts="districts"
        :current-district="currentDistrict"
      />
    </header>
    <section class="popular">
      <div class="container pt-3 pb-5">
        <Header>
          <template v-slot:title>
            熱門餐廳
          </template>
          <template v-slot:description>
            嘗試最受歡迎的餐廳
          </template>
        </Header>
        <RestaurantCarousel :popular-restaurants="popular_restaurants" />
      </div>
    </section>
    <section class="restaurants">
      <div class="container pt-3 pb-5">
        <Header>
          <template v-slot:title>
            更多選擇
          </template>
          <template v-slot:description>
            探索更多在地餐廳
          </template>
        </Header>
        <div class="card-wrapper row">
          <div
            v-for="restaurant in more_restaurants.rows"
            :key="restaurant.id"
            class="col-12 col-md-6 col-lg-4 p-2"
          >
            <RestaurantCard :restaurant="restaurant" />
          </div>
        </div>
        <div class="btn-container">
          <button
            v-if="currentPage !== totalPage"
            class="btn mt-3"
            href="#"
            @click="fetchRestaurants(currentDistrict, currentPage + 1)"
          >
            瀏覽更多
          </button>
        </div>
      </div>
    </section>
    <section class="map bg-white">
      <div class="container pt-3 pb-5">
        <Header>
          <template v-slot:title>
            {{ currentDistrict }}餐廳
          </template>
          <template v-slot:description>
            探索最近的美食地圖
          </template>
        </Header>
        <GMap
          v-if="!isLoading"
          :center="{lat: parseFloat(map.center.lat), lng: parseFloat(map.center.lng)}"
          :locations="map.restaurants"
          :street-view-control="false"
          :map-type-control="false"
          :fullscreen-control="true"
          :zoom-control="true"
          class="shadow-sm rounded-sm"
        />
      </div>
    </section>
    <Footer />
  </section>
</template>

<script>
import Navbar from '../components/Navbar'
import Footer from '../components/Footer'
import DropdownBanner from '../components/Banner/DropdownBanner'
import RestaurantCarousel from '../components/RestaurantCarousel'
import RestaurantCard from '../components/RestaurantCard'
import GMap from '../components/GMap'
import Header from '../components/Header'
import restaurantsAPI from '../apis/restaurants'
import { Toast } from '../utils/helpers'

export default {
  components: {
    Navbar,
    Footer,
    DropdownBanner,
    RestaurantCarousel,
    RestaurantCard,
    GMap,
    Header
  },
  data () {
    return {
      popular_restaurants: [],
      more_restaurants: {
        rows: []
      },
      map: {},
      districts: [],
      currentDistrict: '',
      currentPage: 0,
      totalPage: null,
      isLoading: true
    }
  },
  created () {
    const { dist } = this.$route.query
    this.currentDistrict = dist || '信義區'
    this.fetchRestaurants(dist, this.currentPage + 1)
  },
  beforeRouteUpdate (to, from, next) {
    // Reset current page
    this.currentPage = 0
    // Clear existing restaurants
    this.more_restaurants.rows = []
    // Get the district name
    const { dist } = to.query
    this.currentDistrict = dist || '信義區'
    // Refetch the restaurant data
    this.fetchRestaurants(dist, this.currentPage + 1)
    next()
  },
  methods: {
    async fetchRestaurants (dist, page) {
      this.isLoading = true
      try {
        // fetch data from API
        const { data, statusText } = await restaurantsAPI.getRestaurants({ dist, page })
        // error handling
        if (data.status !== 'success' || statusText !== 'OK') throw new Error(data.message)

        // fetch data from api
        this.popular_restaurants = data.popular_restaurants || this.popular_restaurants
        this.more_restaurants.rows = [
          ...this.more_restaurants.rows,
          ...data.more_restaurants.rows[0]
        ]
        this.totalPage = data.more_restaurants.pages

        this.map = data.map || this.map
        this.districts = data.districts || this.districts
        // update current page number
        this.currentPage += 1
        this.isLoading = false
      } catch (error) {
        console.log(error.message)
        // update loading status
        this.isLoading = false
        // fire error messages
        Toast.fire({
          type: 'error',
          title: '無法取得餐廳資料，請稍後再試'
        })
      }
    }
  }
}
</script>

<style lang="scss" scoped>
.google-map {
  width: 100%;
  height: 400px;
}

.btn-container {
    text-align: center;
    .btn {
        @include buttonOutline;
    }
}
</style>
